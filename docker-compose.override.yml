version: '3.9'

services:
  server:
    image: node:16
    volumes:
      - ./:/code
    working_dir: /code/server
    command: npm start
    ports:
      - '8000:8000'
    environment:
      - NODE_ENV=dev

  mongodb:
    ports:
      - '27017:27017'

  client:
    container_name: hhahaiti_client
    depends_on:
      - log_metrics_processor
    image: node:16
    volumes:
      - ./:/code
    working_dir: /code/client
    command: npm start
    ports:
      - '3000:3000'
    logging:
      driver: fluentd

  caddy:
    image: caddy:2.6.4
    container_name: hhahaiti_caddy
    depends_on:
      - log_metrics_processor
    restart: unless-stopped
    volumes:
      - ./caddy/Caddyfile_local:/etc/caddy/Caddyfile_local
      # - ./client/build:/var/www/
    environment:
      - DOMAIN=myapp.local.test
      - API_HOSTNAME=hhahaiti_server
    ports:
      - '9443:443'
      - '2019:2019'
    logging:
      driver: fluentd

  loki:
    image: grafana/loki:2.8.0
    container_name: hhahaiti_loki
    ports:
      - '3100:3100'
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml
      
  grafana:
    image: grafana/grafana-enterprise
    container_name: hha_grafana
    restart: unless-stopped
    ports:
      - '8443:3000'
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SERVER_ROOT_URL=http://localhost:8443/
      - GF_INSTALL_PLUGINS=grafana-clock-panel

volumes:
  grafana_data:
